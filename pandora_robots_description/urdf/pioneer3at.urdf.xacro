<?xml version="1.0"?>

<robot xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor"
       xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
       xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface"
       xmlns:xacro="http://ros.org/wiki/xacro"
       name="pioneer3at">

<!-- base_link -->
  <link name="base_link">
    <inertial>
      <mass value="10.0"/>
      <origin xyz="0 0 0"/>
      <inertia ixx="0.3338" ixy="0.0" ixz="0.0"
         iyy="0.4783" iyz="0.0"
         izz="0.3338"/>
    </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/chassis.stl"/>
      </geometry>
      <material name="ChassisRed">
        <color rgba="0.851 0.0 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/chassis.stl"/>
        </geometry>
    </collision>
  </link>

  <gazebo reference="base_link">
    <material value="Gazebo/Red"/>
  </gazebo>
  
<!-- Top -->
  <link name="top_plate">
    <inertial>
      <mass value="0.1"/>	
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="1.0" ixy="0.0" ixz="0.0"
         iyy="1.0" iyz="0.0"
        izz="1.0"/>
    </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/top.stl"/>
      </geometry>
      <material name="TopBlack">
          <color rgba="0.038 0.038 0.038 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0 0 0"/>
      </geometry>
    </collision>
  </link>
  <gazebo reference="top_plate">
    <material value="Gazebo/Black"/>
  </gazebo>

  <joint name="base_top_joint" type="fixed">
    <origin xyz="-0.025 0 0.096"/>
    <parent link="base_link"/>
    <child link="top_plate"/>
  </joint>

  <!-- Front Axles + Wheels + Hubcaps -->
  <xacro:macro name="p3at_front" params="suffix reflect">
    <link name="p3at_front_${suffix}_axle">
      <inertial>
        <mass value="0.1"/>	
        <origin xyz="0 0 0"/>
        <inertia ixx="1.0" ixy="0.0" ixz="0.0"
           iyy="1.0" iyz="0.0" izz="1.0"/>
        </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/axle.stl"/>
      </geometry>
      <material name="AxleGrey">
        <color rgba="0.5 0.5 0.5 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0 0 0"/>
      </geometry>
    </collision>
    </link>
    <gazebo reference="p3at_front_${suffix}_axle">
      <material value="Gazebo/Grey"/>
    </gazebo>
  
    <joint name="base_front_${suffix}_axle_joint" type="fixed">
      <origin xyz="0.135 ${reflect*0.156} -0.066" rpy="0 0 0"/>
      <parent link="base_link"/>
      <child link="p3at_front_${suffix}_axle"/>
    </joint>
  
    <link name="p3at_front_${suffix}_hub">
      <inertial>
        <mass value="0.1"/>	
        <origin xyz="0 0 0"/>
        <inertia ixx="1.0" ixy="0.0" ixz="0.0"
           iyy="1.0" iyz="0.0" izz="1.0"/>
        </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/${suffix}_hubcap.stl"/>
      </geometry>
      <material name="HubcapYellow">
        <color rgba="1.0 0.811 0.151 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0 0 0"/>
      </geometry>
    </collision>
    </link>
    <gazebo reference="p3at_front_${suffix}_hub">
      <material value="Gazebo/Yellow"/>
    </gazebo>
  
    <joint name="base_front_${suffix}_hub_joint" type="fixed">
      <origin xyz="0 ${reflect*0.041} 0" rpy="0 0 0"/>
      <parent link="p3at_front_${suffix}_axle"/>
      <child link="p3at_front_${suffix}_hub"/>
    </joint>
  
    <link name="p3at_front_${suffix}_wheel">
      <inertial>
        <mass value="0.5"/>	
        <origin xyz="0 0 0"/>
        <inertia ixx="0.012411765597" ixy="0" ixz="0"
           iyy="0.015218160428" iyz="0" izz="0.011763977943"/>
        </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/wheel.stl"/>
      </geometry>
      <material name="WheelBlack">
        <color rgba="0.117 0.117 0.117 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="${-3.1415927/2} 0 0"/>
      <geometry>
        <!--mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/wheel.stl"/-->
        <cylinder radius="0.111" length="0.075"/>
      </geometry>
    </collision>
    </link>
    <gazebo reference="p3at_front_${suffix}_wheel">
      <material value="Gazebo/Black"/>
    </gazebo>
  
    <joint name="p3at_front_${suffix}_wheel_joint" type="continuous">
      <axis xyz="0 1 0"/>
      <anchor xyz="0 0 0"/>
      <limit effort="100" velocity="100" />
      <joint_properties damping="0.7"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="p3at_front_${suffix}_hub"/>
      <child link="p3at_front_${suffix}_wheel"/>
    </joint>
    
  
  <!-- Back Axles + Wheels + Hubcaps -->
    <link name="p3at_back_${suffix}_axle">
      <inertial>
        <mass value="0.1"/>	
        <origin xyz="0 0 0"/>
        <inertia ixx="1.0" ixy="0.0" ixz="0.0"
           iyy="1.0" iyz="0.0" izz="1.0"/>
        </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/axle.stl"/>
      </geometry>
      <material name="AxleGrey">
        <color rgba="0.5 0.5 0.5 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/axle.stl"/>
      </geometry>
    </collision>
    </link>
    <gazebo reference="p3at_back_${suffix}_axle">
      <material value="Gazebo/Grey"/>
    </gazebo>
  
    <joint name="bp3at_back_${suffix}_axle_joint" type="fixed">
      <origin xyz="-0.134 ${reflect*0.156} -0.066" rpy="0 0 0"/>
      <parent link="base_link"/>
      <child link="p3at_back_${suffix}_axle"/>
    </joint>
  
  
    <link name="p3at_back_${suffix}_hub">
      <inertial>
        <mass value="0.1"/>	
        <origin xyz="0 0 0"/>
        <inertia ixx="1.0" ixy="0.0" ixz="0.0"
           iyy="1.0" iyz="0.0" izz="1.0"/>
        </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/${suffix}_hubcap.stl"/>
      </geometry>
      <material name="HubcapYellow"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/${suffix}_hubcap.stl"/>
      </geometry>
    </collision>
    </link>
    <gazebo reference="p3at_back_${suffix}_hub">
      <material value="Gazebo/Yellow"/>
    </gazebo>
  
    <joint name="p3at_back_${suffix}_hub_joint" type="fixed">
      <origin xyz="-0 ${reflect*0.041} 0" rpy="0 0 0"/>
      <parent link="p3at_back_${suffix}_axle"/>
      <child link="p3at_back_${suffix}_hub"/>
    </joint>
  
    <link name="p3at_back_${suffix}_wheel">
      <inertial>
        <mass value="0.5"/>	
        <origin xyz="0 0 0"/>
        <inertia ixx="0.012411765597" ixy="0" ixz="0"
           iyy="0.015218160428" iyz="0" izz="0.011763977943"/>
        </inertial>
    <visual name="base_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry name="pioneer_geom">
        <mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/wheel.stl"/>
      </geometry>
      <material name="WheelBlack"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="${-3.1415927/2} 0 0"/>
      <geometry>
        <!--<mesh filename="package://pandora_robots_description/meshes/pioneer3at/p3at_meshes/wheel.stl"/>-->
        <cylinder radius="0.111" length="0.075"/>
      </geometry>
    </collision>
    </link>
    <gazebo reference="p3at_back_${suffix}_wheel">
      <material value="Gazebo/Black"/>
    </gazebo>
  
    <joint name="p3at_back_${suffix}_wheel_joint" type="continuous">
      <axis xyz="0 1 0"/>
      <anchor xyz="0 0 0"/>
      <limit effort="100" velocity="100" />
      <joint_properties damping="0.7"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="p3at_back_${suffix}_hub"/>
      <child link="p3at_back_${suffix}_wheel"/>
    </joint>
    
    <gazebo reference="p3at_back_${suffix}_wheel">
      <kp>1000000.0</kp> <!-- kp and kd for rubber -->
      <kd>100.0</kd>
      <mu1>10.0</mu1>
      <mu2>1.0</mu2>
      <fdir1>0 1 0</fdir1> <!-- is this correct? -->
      <maxVel>1.0</maxVel>
      <minDepth>0.00</minDepth>
    </gazebo>
    
    <gazebo reference="p3at_front_${suffix}_wheel">
      <kp>1000000.0</kp> <!--<limit effort="30" velocity="10.0" /> kp and kd for rubber -->
      <kd>100.0</kd>
      <mu1>10.0</mu1>
      <mu2>1.0</mu2>
      <fdir1>0 1 0</fdir1> <!-- is this correct? -->
      <maxVel>1.0</maxVel>
      <minDepth>0.00</minDepth>
    </gazebo>
  
  
      <transmission name="p3at_front_${suffix}_wheel_transmission">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="p3at_front_${suffix}_wheel_joint"/>
      <actuator name="p3at_front_${suffix}_motor">
        <hardwareInterface>VelocityJointInterface</hardwareInterface>
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
    
    <transmission name="p3at_back_${suffix}_wheel_transmission">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="p3at_back_${suffix}_wheel_joint"/>
      <actuator name="p3at_back_${suffix}_motor">
        <hardwareInterface>VelocityJointInterface</hardwareInterface>
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro>



  <xacro:p3at_front suffix="left" reflect="1"/>
  <xacro:p3at_front suffix="right" reflect="-1"/>
  <xacro:p3at_back suffix="left" reflect="1"/>
  <xacro:p3at_back suffix="right" reflect="-1"/>

  <!-- Add skid steer drive plugin-->
  <gazebo>
    <plugin name="RosSkidSteerDrivePlugin" filename="libgazebo_ros_skid_steer_drive.so">
      <updateRate>50.0</updateRate>
      <robotNamespace></robotNamespace>
      <leftFrontJoint>p3at_front_left_wheel_joint</leftFrontJoint>
      <rightFrontJoint>p3at_front_right_wheel_joint</rightFrontJoint>
      <leftRearJoint>p3at_back_left_wheel_joint</leftRearJoint>
      <rightRearJoint>p3at_back_right_wheel_joint</rightRearJoint>
      <wheelSeparation>0.4</wheelSeparation>
      <wheelDiameter>0.220</wheelDiameter>
      <robotBaseFrame>base_link</robotBaseFrame>
      <topicName>cmd_vel</topicName>
      <broadcastTF>0</broadcastTF>
      <torque>5.0</torque>
      <commandTopic>cmd_vel</commandTopic>
      <odometryTopic>odom</odometryTopic>
      <odometryFrame>odom</odometryFrame>
    </plugin>
  </gazebo>
  
  <!--Insert hokuyo laser-->
  <xacro:include filename="$(find pandora_sensors_description)/urdf/hokuyo_utm_30lx.urdf.xacro" />
  
  <xacro:hokuyo_caster parent="base_link">
    <origin xyz="0.25 0 0.15" rpy="0 0 0"/>
  </xacro:hokuyo_caster>

  <!-- Add imu plugin-->
  <gazebo>	
    <plugin name="RosImuPlugin" filename="libpandora_imu_stabilizer_plugin.so">
      <topicName>/sensors/imu</topicName>
      <bodyName>base_link</bodyName>
      <updateRate>50.0</updateRate>
      <robotNamespace></robotNamespace>
      <serviceName>default_imu</serviceName>
      <gaussianNoise>0.0</gaussianNoise>
      <xyzOffset>0 0 0</xyzOffset>
      <rpyOffset>0 0 0</rpyOffset>
      <rollCorrectionJoint>laser_roll_joint</rollCorrectionJoint>
      <pitchCorrectionJoint>laser_pitch_joint</pitchCorrectionJoint>
    </plugin>
  </gazebo>

  
  <!--Insert kinect-->	
  <xacro:include filename="$(find pandora_sensors_description)/urdf/kinect_camera.urdf.xacro" />
  
  <xacro:kinect_caster parent="base_link">
    <origin xyz="0.2 0 0.33" rpy="0 0 0"/>
  </xacro:kinect_caster>
  
  <!--Insert sonars-->
  <xacro:include filename="$(find pandora_sensors_description)/urdf/sonar_sensor.urdf.xacro" />
  
  <xacro:sonar_caster name="left_rear" parent="base_link">
    <origin xyz="-0.2 0.15 0.13" rpy="0 0 3.14" />
  </xacro:sonar_caster>
  
  <xacro:sonar_caster name="right_rear" parent="base_link">
    <origin xyz="-0.2 -0.15 0.13" rpy="0 0 3.14" />
  </xacro:sonar_caster>
  
  <!--Insert thermal-->	
  <xacro:include filename="$(find pandora_sensors_description)/urdf/thermal_sensor.urdf.xacro" />
  
  <xacro:thermal_caster parent="base_link">
    <origin xyz="0.2 -0.05 0.23" rpy="0 0 0"/>
  </xacro:thermal_caster>
  
  <!--Insert co2 sensor-->	
  <xacro:include filename="$(find pandora_sensors_description)/urdf/co2_sensor.urdf.xacro" />
  
  <xacro:co2_caster parent="base_link">
    <origin xyz="0.2 0 0.36" rpy="0 0 0"/>
  </xacro:co2_caster>
  
  <!--Insert microphone-->	
  <xacro:include filename="$(find pandora_sensors_description)/urdf/microphone_sensor.urdf.xacro" />
  
  <xacro:microphone_caster parent="base_link">
    <origin xyz="0.2 0 0.38" rpy="0 0 0"/>
  </xacro:microphone_caster>
  
</robot>
