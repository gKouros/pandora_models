<?xml version="1.0" ?>

<robot xmlns:xacro="http://ros.org/wiki/xacro" >

  <xacro:macro name="kinect_caster"
               params="parent
                       control
                       pitch_min_limit
                       pitch_max_limit
                       yaw_min_limit
                       yaw_max_limit
                       *origin" >

    <link name="kinect_link" >

      <inertial>
        <origin xyz="0.0023 -0.00024 0.01818"
                rpy="0 0 0" />
        <mass value="0.226796185" />
        <inertia ixx="1.4641E-3"
                 ixy="0.0"
                 ixz="0.0"
                 iyy="9.2532E-5"
                 iyz="0.0"
                 izz="1.5077E-3" />
      </inertial>

      <collision name="collision" >
        <origin xyz="0.0 0.0 0.018" />
        <geometry>
          <box size="0.079 0.295 0.055" />
        </geometry>
      </collision>

      <visual name="visual" >
        <geometry>
          <mesh filename="package://pandora_sensors_description/meshes/kinect_camera/kinect_camera_simple.dae" />
        </geometry>
      </visual>

    </link>

    <gazebo reference="kinect_link" >

      <sensor name="kinect"
              type="depth" >

        <update_rate>20</update_rate>

        <camera>

          <horizontal_fov>1.047198</horizontal_fov>

          <image>
            <width>640</width>
            <height>480</height>
            <format>R8G8B8</format>
          </image>

          <clip>
            <near>0.3</near>
            <far>3</far>
          </clip>

        </camera>

        <plugin name="depth2ros"
                filename="libgazebo_ros_openni_kinect.so" >

          <pointCloudTopicName>point_cloud</pointCloudTopicName>
          <frameName>kinect_camera</frameName>
          <cameraName>kinect</cameraName>
          <imageTopicName>image</imageTopicName>
          <depthImageTopicName>depth/image</depthImageTopicName>
          <depthImageCameraInfoTopicName>depth/image/info</depthImageCameraInfoTopicName>
          <pointCloudCutoff>0.4</pointCloudCutoff>

        </plugin>

      </sensor>

    </gazebo>

    <link name="kinect_base_link" >

      <inertial>
        <origin xyz="0.02347 0.0 0.00124" />
        <mass value="0.0001" /><!--FIXME-->
        <inertia ixx="0.00000001"
                 ixy="0"
                 ixz="0"
                 iyy="0.00000001"
                 iyz="0"
                 izz="0.00000001" /><!--FIXME-->
      </inertial>

      <visual>
        <origin xyz="0 0 0"
                rpy="0 0 0" />
        <geometry>
          <mesh filename="package://pandora_robots_description/meshes/gears/visual/servo_motor.dae" />
        </geometry>
      </visual>

      <collision>
        <origin xyz="0.02347 0.0 0.00124"
                rpy="0 0 0" />
        <geometry>
          <box size="0.050 0.032 0.041" />
        </geometry>
      </collision>

    </link>
    
    <!-- Pitch Joint #######################################################-->

    <xacro:if value="${control}" >

      <joint name="kinect_pitch_joint"
             type="revolute" >

        <parent link="${parent}" />
        <child link="kinect_base_link" />

        <xacro:insert_block name="origin" />

        <axis xyz="0 1 0" />
        <limit lower="${pitch_min_limit}"
               upper="${pitch_max_limit}"
               effort="50"
               velocity="50.0" />

      </joint>
      
    </xacro:if>

    <xacro:unless value="${control}" >

      <joint name="kinect_pitch_joint"
             type="fixed" >

        <parent link="${parent}" />
        <child link="kinect_base_link" />

        <xacro:insert_block name="origin" />

      </joint>
      
    </xacro:unless>
    
    <!-- Yaw Joint #########################################################-->

    <xacro:if value="${control}" >

      <joint name="kinect_yaw_joint"
             type="revolute" >

        <parent link="kinect_base_link" />
        <child link="kinect_link" />

        <origin xyz="0.037 0.0 0.021"
                rpy="0.0 0.0 0.0" />

        <axis xyz="0 0 1" />
        <limit lower="${yaw_min_limit}"
               upper="${yaw_max_limit}"
               effort="50"
               velocity="50.0" />

      </joint>
      
    </xacro:if>

    <xacro:unless value="${control}" >

      <joint name="kinect_yaw_joint"
             type="fixed" >

        <parent link="kinect_base_link" />
        <child link="kinect_link" />

        <origin xyz="0.037 0.0 0.021"
                rpy="0.0 0.0 0.0" />

      </joint>
      
    </xacro:unless>

  </xacro:macro>

</robot>
